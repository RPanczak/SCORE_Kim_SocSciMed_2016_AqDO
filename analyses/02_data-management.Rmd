---
title: "SCORE: Kim & Radoias (2016) reproduction"
subtitle: "Data preparation"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
  code_folding: show
self_contained: true
highlight: pygments
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../docs") })
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
set.seed(12345)
options(scipen = 999)
options(max.print = "75")
library(pacman)
p_load(tidyverse, magrittr, scales, haven, lubridate, sjmisc)
```

```{r knit-setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)
knitr::opts_knit$set(width = 125)
mu <- Hmisc::markupSpecs$html
```

<!-- ------------------------------------------------------------ --> 

# Data source 

The fourth wave of the Indonesia Family Life Survey (IFLS4) available for download [here](https://www.rand.org/well-being/social-and-behavioral-policy/data/FLS/IFLS/ifls4.html).  

Documentation is available [here](https://www.rand.org/well-being/social-and-behavioral-policy/data/FLS/IFLS/download.html).  

# Variables

## DOB, age, sex, blood pressure

From `bus1_1.dta` file:   

`us00`      Respondent measured?
*1. Yes*

`us01`      Sex  
1. Male
3. Female

`us03`      Age  

`us02yr`    Year of birth  

`us07bx`    Blood pressure (2nd measurement)  
`us07b1`    Blood pressure (2nd measurement)  
`us07b2`    Blood pressure (2nd measurement)  
`us07bp`    Blood pressure (2nd measurement)  

From `bus1_2.dta` file:    

`us07cx`    Blood pressure (3rd measurement)  
`us07c1`    Blood pressure (3rd measurement)  
`us07c2`    Blood pressure (3rd measurement)  
`us07cp`    Blood pressure (3rd measurement)  

Selecting 

- 'measured' respondents 
- respondents with non-missing info on sex and age
- respondents 45 years of age and above
- respondents with non-missing info on blood pressure measurements.   

At next step the second and third bp measures were averaged and finally hypertensive individuals only were retained.  

```{r}
bus1_1 <- read_dta("data-raw/IFLS4/hh07_all_dta/bus1_1.dta") %>% 
  # zap_label() %>% 
  zap_labels() %>% zap_formats() %>%
  select(hhid07_9,hhid07, pid07,
         us00,
         us01, us03,
         us02yr,
         us07bx, us07b1, us07b2) %>% 
  mutate_all(as.numeric) %>% 
  # missing sex
  filter(!is.na(us01)) %>% 
  # implausible DOB
  mutate(us02yr = if_else(us02yr >= 9998, NA_real_, us02yr)) %>% 
  # missing age
  filter(us03 < 998) %>% 
  # age inclusion
  filter(us03 >= 45) %>% 
  # only measured respondents
  filter(us00 == 1) %>% 
  select(-us00) %>% 
  # bp1 measured
  filter(us07bx == 1) %>% 
  select(-us07bx) %>% 
  # missing bp
  filter(us07b1 != 999) %>% 
  filter(us07b2 != 999) 

bus1_2 <- read_dta("data-raw/IFLS4/hh07_all_dta/bus1_2.dta") %>% 
  # zap_label() %>% 
  zap_labels() %>% zap_formats() %>%
  select(hhid07, pid07,
         us07cx, us07c1, us07c2) %>% 
  mutate_all(as.numeric) %>% 
  # bp2 measured
  filter(us07cx == 1) %>% 
  # missing bp
  filter(us07c1 != 999) %>% 
  filter(us07c2 != 999) %>% 
  select(-us07cx)

bus_1 <- 
  inner_join(bus1_1, bus1_2) %>%
  # average of two bp measures (2nd and tird)
  rowwise() %>% 
  mutate(us071 = mean(c(us07b1, us07c1), na.rm = FALSE),
         us072 = mean(c(us07b2, us07c2), na.rm = FALSE)) %>% 
  ungroup() %>% 
  select(-us07b1, -us07c1, -us07b2, -us07c2) %>% 
  # selecting hypertensive
  filter(us071 > 140 | us072 > 90) %>% 
  select(-us071, -us072) %>%
  rename(sex = us01,
         age = us03) %>% 
  mutate(age2 = age*age) %>% 
  relocate(age2, .after = age)

rm(bus1_1, bus1_2)
```

```{r}
frq(bus_1, sex)

summary(bus_1$age)
```

## Hypertension diagnosed

From `b3b_cd3.dta` file.   

`cdtype`    Type chronic conditions  
A. Hypertension  

`cd05`    Has a doctor ever told you that you had  
1. Yes   

```{r}
b3b_cd3  <- read_dta("data-raw/IFLS4/hh07_all_dta/b3b_cd3.dta") %>% 
  # zap_label() %>% 
  zap_labels() %>% zap_formats() %>%
  select(pid07, hhid07,
         cd05, cdtype) %>% 
  filter(cdtype == "A") %>% 
  select(-cdtype) %>% 
  mutate_all(as.numeric) %>% 
  # excluding missing
  filter(cd05 != 9) %>% 
  # outcome is NO diagnosis
  mutate(cd05 = ifelse(cd05 == 1, 0, cd05)) %>% 
  mutate(cd05 = ifelse(cd05 == 3, 1, cd05)) %>% 
  rename(underdiagnosed = cd05)
```

```{r}
frq(b3b_cd3, underdiagnosed)
```

## Household expenditures

From `b1_ks2.dta` file.   

`ks06`    nonfood expenditure last month (Rp)  

Multiple types of expenditures are aggregated by household.  

```{r}
b1_ks2  <- read_dta("data-raw/IFLS4/hh07_all_dta/b1_ks2.dta") %>% 
  # zap_label() %>% 
  zap_labels() %>% zap_formats() %>%
  select(hhid07,
         ks06) %>% 
  mutate_all(as.numeric) %>% 
  group_by(hhid07) %>% 
  summarize(expenditures = sum(ks06)) %>% 
  ungroup()
```

```{r}
summary(b1_ks2$expenditures)
```

## Health status

From `b3b_kk1.dta` file.  

`kk01`    Generally how is your health?  

1. Very healthy
2. Fairly healthy
3. In poor health
4. Very sick

```{r}
b3b_kk1  <- read_dta("data-raw/IFLS4/hh07_all_dta/b3b_kk1.dta") %>% 
  # zap_label() %>% 
  zap_labels() %>% zap_formats() %>%
  select(pid07, hhid07,
         kk01) %>% 
  mutate_all(as.numeric) %>% 
  mutate(poor_health = ifelse(kk01 >= 3, 1, 0)) %>% 
  select(-kk01)
```

```{r}
frq(b3b_kk1, poor_health)
```

## Distance to Health facilities

Again paper is rather cryptic and specifies it only as:  

> the distance from the closest health center (to proxy for the ease of access to medical care)  

`pp5`       One way travel time (unit of measurement)  

`pptype`    Type of out-patient facility  
C. Public Health Center/Auxiliary Center   


```{r}
b1_pp  <- read_dta("data-raw/IFLS4/hh07_all_dta/b1_pp.dta") %>% 
  # zap_label() %>% 
  zap_labels() %>% zap_formats() %>%
  select(hhid07_9,
         pptype,
         pp5, pp5x) %>% 
  # facility type
  filter(pptype == "C") %>% 
  select(-pptype) %>% 
  mutate_all(as.numeric) %>% 
  # exclude missings
  filter(pp5x < 30) %>% 
  # standardize other units to minutes
  mutate(pp5 = ifelse(pp5x == 2, pp5*60, pp5)) %>% 
  mutate(pp5 = ifelse(pp5x == 3, pp5*24*60, pp5)) %>% 
  select(-pp5x) %>% 
  rename(travel_time = pp5)
```

```{r}
summary(b1_pp$travel_time)
```

## Education

Paper defines it as: 

> measured in years of formal education

From `b3a_dl1.dta` file we can grab:    

`dl04`        Have you ever attended school?

`dl05a`       At what age did you enter school  

`dl06`        Highest level of education attended

`dl07byr`     Year graduated or left school  

`dl07d`       IVWR NOTE: Still in school
1. Yes

These together with `dob` can be used to obtain crude years of education.  

```{r}
b3a_dl1 <- read_dta("data-raw/IFLS4/hh07_all_dta/b3a_dl1.dta") %>% 
  # zap_label() %>% 
  zap_labels() %>% zap_formats() %>%
  select(pid07, hhid07,
         dl04,
         dl06,
         dl07d, 
         dl05a, dl07byr) %>% 
  mutate_all(as.numeric) %>% 
  # if still in school replace to 2007, year of survey
  mutate(dl07byr = ifelse (is.na(dl07byr) & dl07d == 1, 2007, dl07byr)) %>% 
  # missings
  filter(dl07byr < 9998 | is.na(dl07byr)) %>%
  filter(dl05a < 98 | is.na(dl07byr)) %>% 
  select(-dl07d)
```

## Risk & time preference

> For the time and risk preference parameters, we follow Ng (2013) and group respondents in four distinct groups from the most patient to the most impatient, respectively from the least risk averse to the most risk averse.   

```{r}
# b3a_si <- read_dta("data-raw/IFLS4/hh07_all_dta/b3a_si.dta") %>% 
#   select(pid07, hhid07,
#          ) 
```

TBD..  

## Disease management

> We construct a dummy variable that is equal to 1 if respondents checked their blood pressure at least once in the month preceding the interview.  

> Disease management does not apply to individuals who are not aware of having any disease, so we restrict our sample to those respondents who were previously diagnosed with hypertension.  

From `b3b_rj3.dta` file we can grab:    

`rj24amth`    Last blood pressure check (month)  
`rj24ayr`     Last blood pressure check (year)  


```{r}
b3b_rj3 <- read_dta("data-raw/IFLS4/hh07_all_dta/b3b_rj3.dta") %>% 
  # zap_label() %>% 
  zap_labels() %>% zap_formats() %>%
  select(pid07, hhid07_9,
         rj24amth, rj24ayr) %>% 
  mutate_all(as.numeric) %>% 
  # missings
  filter(!is.na(rj24amth)) %>% 
  filter(!is.na(rj24ayr)) %>% 
  filter(rj24amth < 98) %>% 
  filter(rj24ayr < 9998) %>% 
  mutate(bp_date = ymd(paste(rj24ayr, rj24amth, 1, sep= " "))) 
```

From the file `b1_cov.dta` we can grab:  

`ivwday1`       Date of intrvw (day of month)(1)
`ivwmth1`       Date of interview (month)(1)
`ivwyr1`        Date of Visit (year)(1)

```{r}
b1_cov <- read_dta("data-raw/IFLS4/hh07_all_dta/b1_cov.dta") %>% 
  # zap_label() %>% 
  zap_labels() %>% zap_formats() %>%
  select(pid07, hhid07_9,
         # ivwday1, # fixing 1st to correctly get differences
         ivwmth1, ivwyr1) %>% 
  mutate_all(as.numeric) %>% 
  filter(!is.na(ivwmth1)) %>% 
  filter(!is.na(ivwyr1)) %>% 
  mutate(ivwyr1 = ivwyr1 + 2000) %>% 
  mutate(iv_date = ymd(paste(ivwyr1, ivwmth1, 1, sep= " "))) 
```

These dates can be then compared to generate an indicator of measurement in the month proceeding the interview.  

Note: values of BP measurement that are dated **after** date of interview are considered implausible and do not count towards the positive indicator.  

```{r}
b3b_rj3 %<>% inner_join(b1_cov) %>% 
  mutate(bp_dist = as.numeric(iv_date - bp_date)) %>% 
  mutate(bp_month = if_else(bp_dist > 0 & bp_dist <= 31, 1, 0)) %>% 
  select(-ivwyr1, -ivwmth1,
         - rj24ayr, -rj24amth,
         -iv_date, -bp_date,
         -bp_dist)

rm(b1_cov)
```

```{r}
frq(b3b_rj3, bp_month)
```

# Final dataset

## Merging together

Due to very large amount of missing information on the number of years of education, categorical variable of highest education achieved was used to impute values into simple four categories of 'elementary', 'junior high', 'senior high' and 'university'.  

Similarly, large amount of missings in the disease management indicator was assumed to mean 'no'.  

```{r}
data <- bus_1 %>% 
  
  # hyper diagnosis
  left_join(b3b_cd3) %>% 
  # exclude missings
  filter(!is.na(underdiagnosed)) %>% 
  
  # expenditures
  left_join(b1_ks2) %>% 
  # exclude missings
  filter(!is.na(expenditures)) %>% 
  # avoid 0s for log
  mutate(expenditures = if_else(expenditures == 0, 1, expenditures)) %>% 
  # log
  mutate(expenditures_log = log(expenditures)) %>% 
  select(-expenditures) %>% 
  
  # bad health
  left_join(b3b_kk1) %>% 
  # exclude missings
  filter(!is.na(poor_health)) %>%  
  
  # distance
  left_join(b1_pp) %>% 
  # exclude missings
  filter(!is.na(travel_time)) %>% 
  
  # education
  left_join(b3a_dl1) %>% 
  # calculate years of education
  mutate(education = dl07byr - us02yr - dl05a) %>% 
  select(-dl07byr, -us02yr, -dl05a) %>% 
  # zero for those who never attended
  mutate(education = if_else(dl04 == 3, 0, education)) %>% 
  select(-dl04) %>% 
  # imputing education from cateogricals
  # elementary school to 6
  mutate(education = if_else(is.na(education) & dl06 == 2, 6, education)) %>% 
  # junior high to 9
  mutate(education = if_else(is.na(education) & 
                               (dl06 == 3 | dl06 == 4), 9, education)) %>% 
  # senior high to 12
  mutate(education = if_else(is.na(education) & 
                               (dl06 == 5 | dl06 == 6), 12, education)) %>% 
  # uni to 16
  mutate(education = if_else(is.na(education) & 
                               (dl06 == 13 | dl06 == 60 | dl06 == 61), 16, education)) %>%   select(-dl06) %>% 
  filter(!is.na(education)) %>%
  filter(education >= 0) %>%
  
  # disease management
  left_join(b3b_rj3) %>% 
  # second version imputing missing to zero (ie. 'no')
  mutate(bp_month2 = ifelse(is.na(bp_month), 0, bp_month))

# rm(bus_1, b3b_cd3, b1_ks2, b3b_kk1, b1_pp, b3a_dl1, b3b_rj3)
```

## Dataset

```{r echo=FALSE}
data %>% 
  mutate(sex = factor(sex),
         underdiagnosed = factor(underdiagnosed),
         poor_health = factor(poor_health),
         bp_month = factor(bp_month)) %>% 
  report::report()
```


## Summaries

```{r}
frq(data, underdiagnosed)
frq(data, sex)

gmodels::CrossTable(data$sex, data$underdiagnosed,
                    digits = 2, prop.chisq = FALSE)

frq(data %>% filter(underdiagnosed == 0), bp_month)

frq(data, poor_health)
# frq(data, education)
```
